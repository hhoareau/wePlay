<html>
<head>
<meta charset="ISO-8859-1">
<meta name="viewport" content="width=320">
<link rel="stylesheet" type="text/css" href="Leficarbar.css">
    <style type="text/css">
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { height: 100% }
    </style>
    <script src="Tools.js"></script>
    <script src="Main.js"></script>
    <title>Event Maker Form</title>
</head>
<body>


<div id="form" class="main-div">
<h1>Créer un évenement</h1>

    <a href="javascript:sendEvent()" class="mobilebutton">Enregistrer</a>
    <br>
    <br>
 <div style="display:inline-block;width:500px;height:300px" id="map"></div>
<!--

 <input  style="text-align:center" type="text" name="lieu" id="lieu" size="20" value="" autofocus onchange="findLieu();onChangeTitre();">

 <div id="zone_adresse">
 <br><br>
 Adresse (si nouveau lieu)<br>
 <input  style="text-align:center" type="text" name="adresse" id="adresse" size="30" value="" onchange="onChangePicture();">
 <input type="checkbox" name="ici" id="ici">Ici<br>
 </div>

 -->


 <br>Début<br>
 <input  style="text-align:center" type="date" name="dtStart" id="dtStart" size="10" value="" onchange="onChangePicture();">
 <input  style="text-align:center" type="time" name="dtTime" id="dtTime" size="5" value="" onchange="onChangePicture();">
 
 <br><br>
 Duree <input  style="text-align:center;width:50px;" type="number" name="duration" id="duration" value="24"> heures<br>
 
 <br>
Titre de l'évenement<br>
 <input  style="text-align:center" type="text" name="title" id="title" size="20" value=""  onchange="onChangePicture();">
 <br><br>
 
 Mot de passe pour entrer (optionnel)<br>
 <input  style="text-align:center" type="password" name="password" id="password" size="20" value="">
 
 Online
 <input  style="text-align:center;width:50px;" type="number" name="maxonline" id="maxonline" size="5" value="50"> personnes
 
 
<br><br>
 
 Flyer
 <input type="checkbox" id="autoflyer">Auto
  <input type="file" id="flyer" name="flyer" accept="image/*" onchange="onChangePicture();">
  <br>
    <div id="preview"><br></div>
    <img style="margin:3px" id="apercu_flyer" ></img>


 <br><br>
 
 Invités (Un Email par ligne)<br>
 <textarea rows="5" cols="30" name="invites" id="invites"></textarea>


</div>

<script type="text/javascript">

    function sendEvent(){
        var event={};
        if(target==null){
            event.lat=pos.lat;
            event.lng=pos.lng;
        } else{
            event.lat=target.position.lat();
            event.lng=target.position.lng();
        }
        if(event.lat==0 && event.lng==0){
            informe("position de l'evenement incorrecte");
            return false;
        }

        event.title=document.getElementById("title").value;
        if(document.getElementById("dtStart").value.length==0)
            event.dtStart=Date.parse(new Date());
        else
            event.dtStart=Date.parse(StringToDate(document.getElementById("dtStart").value+" "+document.getElementById("dtTime").value));

        event.dtEnd=event.dtStart+document.getElementById("duration").value*1000*3600;
        event.maxOnline=document.getElementById("maxonline").value;
        event.owner=getParam()["email"];
        event.password=document.getElementById("password").value;
        event.flyer=canvas.toDataURL("image/jpeg");
        addevent(getParam()["email"],event,function(){
            document.location.href="selEvent.html?email="+getParam()["email"];
        });
    }

    /*
    function findLieu(){
	
	var txtAdresse=document.getElementById("adresse");
	httpGet("findPlace?name="+document.getElementById("lieu").value,function(rep){
		var adresses=JSON.parse(rep);
		if(adresses.length==0){
			informe("Nouveau lieu, indiquer l'adresse");
			txtAdresse.value="";
		} else {
			txtAdresse.value=adresses[0].number+" "+adresses[0].street+" "+adresses[0].CP;
		}
	});
    }*/

    var canvas = document.createElement("canvas");
    var target=null;
    var map=null;
    var user=null;
    var pos=null;
    var hTimer=null;

function start(){
    informe("Map loading",true,"map");
    loadScript("https://maps.googleapis.com/maps/api/js?key=AIzaSyC9lw5AL7IdrjuJXbHkQ6Gjs8nqtS31AB8",function() {

        var now=new Date();

        getuser(getParam()["email"],function(rep){
            user=rep.result;
            document.getElementById("title").value=user.firstname+"'s night";
        });

        document.getElementById("dtStart").valueAsNumber=Date.parse(new Date());
        var timestr=now.toLocaleTimeString();
        document.getElementById("dtTime").value=timestr.slice(0,5);

        hTimer=setInterval(function(){
            if (navigator.geolocation){
                navigator.geolocation.getCurrentPosition(function(position) {

                    pos = {lat: position.coords.latitude, lng: position.coords.longitude};

                    map = new google.maps.Map(document.getElementById("map"), {
                        center: pos,
                        zoom: 15
                    });

                    target = new google.maps.Marker({
                        position: pos,
                        map: map,
                        name: "Soiree",
                        draggable: true
                    });

                    clearInterval(hTimer);
                });
            }
        },2000);


    });
}


function onChangePicture(){
	var reader = new FileReader();
    reader.onload = (function(theFile) {
        var i=new Image();
        i.src=this.result;
        informe("Image loading",true,"preview");
        i.onload=function(){
            informe("",false,"preview");
            var ratio= i.width/ i.height;
            var ctx=canvas.getContext('2d');

            canvas.width=300;
            canvas.height=canvas.width/ratio;

            var gps="";
            if(target!=null)gps="#GPS:"+target.position.lat().toFixed(3)+","+target.position.lng().toFixed(3);

            ctx.drawImage(i,0,0,canvas.width,canvas.height);
            addText(ctx,20,20,"white",20,"Le "+document.getElementById("dtStart").value,null,300);
            addText(ctx,20,40,"white",15,"à " + document.getElementById("dtTime").value,null,200);
            addText(ctx,150,canvas.height-40,"white",15,document.getElementById("title").value,null,200);
            addText(ctx,150,canvas.height-20,"white",15,gps,null,200);



            document.getElementById("apercu_flyer").src=canvas.toDataURL("image/jpeg");
        }
    });
    reader.readAsDataURL(document.getElementById("flyer").files[0]);
}


</script>

</body>
</html>