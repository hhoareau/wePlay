<html>
<head>
<meta charset="ISO-8859-1">


    <script src="Tools.js"></script>
    <script src="id3v2.js"></script>

    <link rel="stylesheet" type="text/css" href="Leficarbar.css">
    <meta name="viewport" content="width=320">
    <script src="webtorrent.min.js"></script>

<title>Players</title>
</head>
<body>

<div id="dz-root"></div>
<div id="lblMessage"></div>

<script>
    function onloadFrame(i){
        players[i]=$("player"+i).contentWindow;
    }
</script>

<div id="players">
    <iframe id="player0" src="deezerPlayer.html?appid=182662" onload="javascript:onloadFrame(0)"></iframe>
    <!-- <iframe id="player1" src="deezerPlayer.html?appid=182262" onload="javascript:onloadFrame(1)"></iframe> -->
    <iframe id="player2" src="filePlayer.html" onload="javascript:onloadFrame(2)"></iframe>
    <iframe id="player3" src="filePlayer.html" onload="javascript:onloadFrame(3)"></iframe>
</div>


<div id="playlist"></div>
<a class="buttonPhoto" href="javascript:onQuit()">Change Deezer Account</a>
<a class="buttonPhoto" href="javascript:playNextSong()">Next Song</a>

<input id="fileselector" type="file" name="datafile"  name="file[]" accept="audio/*" size="40" webkitdirectory mozdirectory onchange="javascript:analyseDirectory(this)">
    
<script>
var idEvent=getParam()["event"];
var timer=null;
var timerPlay=null;
var crossfadeTimer=null;
var currentPlayer=0;
var players=[null,null,document.getElementById("player2"),document.getElementById("player3")];

var reader = window.jsmediatags;
var file;

function parseFile(file, callback){
    if(localStorage[file.name]) return callback(JSON.parse(localStorage[file.name]),file);
    ID3v2.parseFile(file,function(tags){
        //to not overflow localstorage
        localStorage[file.name] = JSON.stringify({
            Title: tags.Title,
            Artist: tags.Artist,
            Album: tags.Album,
            Genre: tags.Genre,
            File: file.name
        });
        callback(tags,file);
    })
}

function onQuit(){
    players[0].Quit();
}

function getSongs(files,func) {
    var queue = [];
    var j=0;
    var mp3 = canPlay('audio/mpeg;'), ogg = canPlay('audio/ogg; codecs="vorbis"');
    for (var i = 0; i < files.length; i++) {
        var file = files[i];
        var path = file.webkitRelativePath || file.mozFullPath || file.name;

        var size = file.size || file.fileSize || 4096;
        if (size < 4095 || (file.name.indexOf('mp3') == -1 && file.name.indexOf('ogg') == -1 && file.name.indexOf('oga') == -1)) {
            continue;
        }
        file.index=i;
        queue.push(file);
    }

    if(queue.length==0)func(queue);
    for (var i = 0; i < queue.length; i++) {
            parseFile(queue[i],function(tags,f) {
                var t2 = guessSong(f.webkitRelativePath || f.mozFullPath || f.name);
                if((queue[i]!=undefined)){
                    queue[i].title = tags.Title || t2.Title;
                    queue[i].artist = tags.Artist || t2.Artist;
                    queue[i].album = tags.Album || t2.Album;
                    queue[i].genre = tags.Genre || "";
                }

                if(i==queue.length-1)
                    func(queue);
            });
    }
}

function runSearch(query){
    var regex = new RegExp(query.trim().replace(/\s+/g, '.*'), 'ig');
    for(var i = $('songtable').getElementsByTagName('tr'), l = i.length; l--;){
        if(regex.test(i[l].innerHTML)){
            i[l].className = 'visible'
        }else{
            i[l].className = 'hidden';
        }
    }
}

function canPlay(type){
    var a = document.createElement('audio');
    return !!(a.canPlayType && a.canPlayType(type).replace(/no/, ''));
}


function analyseDirectory(finder,func){
    clearTimeout(timer);
    razlocalfile(idEvent,function(){
        setCookie("pathfile",finder.value);
        var lst=[];
        getSongs(finder.files,function(songs){
            for(var i=0;i<songs.length;i++) {
                if (i % 10 == 0)informe(i + "/" + songs.length+" songs analysed", true);
                if(songs[i].title==undefined || songs[i].title==null)continue;
                if(songs[i].name==undefined || songs[i].name==null)continue;
                if(songs[i].artist==undefined || songs[i].artist==null)continue;

                if (songs[i].name.length > 0 && songs[i].title.length > 0 && songs[i].artist.length > 0)
                    lst.push({
                        event: idEvent,
                        text: songs[i].name.toLowerCase(),
                        artist: songs[i].artist.toLowerCase(),
                        title: songs[i].title.toLowerCase(),
                        origin: LOCAL
                    });
            }
            if(lst.length>0)
                uploadfiles({files:lst},function(){
                    informe(lst.length+" songs loaded");
                });
            else
                informe("No song to load");

            playNextSong();
        });
    });
}


function findBestPlayer(id,type){
    if(type==DEEZER)return {old:currentPlayer,new:0};
    if(type==LOCAL)
        if(players[2].isPlaying())
            return {old:currentPlayer,new:3};
        else
            return {old:currentPlayer,new:2};
}


function playNextSong(){
    clearTimeout(timer);
    if(players[currentPlayer]!=null && players[currentPlayer].isReady()){
        getsongtoplay(idEvent,function(rep) {
            if (rep.status == 204) {
                timer = setTimeout(playNextSong, 10000);
            }else{
                clearTimeout(timer);
                var r=findBestPlayer(rep.result.text,rep.result.origin);
                currentPlayer= r.new;

                if(r.old!= r.new) {
                    players[r.old].fade(-5);
                    players[r.new].fade(+10);
                }
                players[r.new].play(rep.result.text,2,function(duration){
                    if(rep.result.duration>0)
                        timer=setTimeout(playNextSong,(rep.result.duration-25)*1000);
                    else
                        timer=setTimeout(playNextSong,(duration-25)*1000);
                });


            }
        });
    } else{
        timer = setTimeout(playNextSong, 5000);
        informe("waiting for the player ...",true);
    }
}


var client = new WebTorrent();

function torrentload(){
    gettopsongs(idEvent,5,function(res){
       res.result.items.forEach(function(song){
          if(song.text.substring(0,4)!="event"){
              getmagnets(song.text,function(res){
                  client.add(res.result.items[0], function (torrent) {
                      // Got torrent metadata!
                      console.log('Client is downloading:', torrent.infoHash);
                      torrent.files.forEach(function (file) {
                          // Display the file by appending it to the DOM. Supports video, audio, images, and
                          // more. Specify a container element (CSS selector or reference to DOM node).
                          file.appendTo('body');
                          console.log("Start downloading ...");
                      });
                  });
              });
          }
       });
    });
}

function chkCompatibility(){
    if (window.createObjectURL) {
    } else if (window.createBlobURL) {
    } else if (window.URL && window.URL.createObjectURL) {
    } else if (window.webkitURL && window.webkitURL.createObjectURL) {
    } else {
        informe("$danger$Your browser probably does not support Object URLs");
    }

    var a = document.createElement('audio');
    if (!a.canPlayType) informe("$danger$Your browser does not support HTML5 Audio<br>");
    if (!(a.canPlayType && a.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/, '')))
        informe("$danger$Your browser does not support Ogg Vorbis Playback<br>");
    if (!(a.canPlayType && a.canPlayType('audio/mpeg;').replace(/no/, '')))
        informe("$danger$Your browser does not support MP3 Playback<br>");
}


function start(){

    chkCompatibility();
    razlocalfile(idEvent);

    //Utiliser un torrent : WebTorrent
    //var WebTorrent = require('webtorrent');
    /*

    var magnetURI = 'magnet:?xt=urn:btih:F6B163EC5643A37E4A44D38FE9B538D261D020A9&dn=single+yo+gotti+rihanna+feat+young+thug+hip+hop+rap+single+2015+itunes+plus+m4a+aac+exclusive+june+2015+uj+rip&tr=udp%3A%2F%2Ftracker.publicbt.com%2Fannounce&tr=udp%3A%2F%2Fglotorrents.pw%3A6969%2Fannounce&tr=udp%3A%2F%2Ftracker.openbittorrent.com%3A80%2Fannounce&tr=udp%3A%2F%2Ftracker.opentrackr.org%3A1337%2Fannounce';

    */
    //document.getElementById("fileselector").value=getCookie("pathfile");
    //torrentload();
    setTimeout(playNextSong,10000);

}
</script>


<script src="Main.js"></script>

</body>
</html>